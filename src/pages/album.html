<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Simple Wallpaper Changer</title>
		<link rel="stylesheet" href="../style/bulma.min.css" />
		<link rel="stylesheet" href="../style/bulma-tooltip.css" />
		<link rel="stylesheet" href="../style/fa-all.min.css" />
		<link rel="stylesheet" href="../style/index.css" />
		<script defer src="../js/handler/files.js"></script>
		<script defer src="../js/handler/modal.js"></script>
	</head>

	<body>
		<div class="box menu-container content">
			<div class="tabs is-centered">
				<ul class="m-0">
					<li>
						<a href="../index.html">
							<span class="icon is-small"><i class="fas fa-home" aria-hidden="true"></i></span>
							<span>Main Menu</span>
						</a>
					</li>
					<li class="is-active">
						<a>
							<span class="icon is-small"><i class="fas fa-images" aria-hidden="true"></i></span>
							<span>Album</span>
						</a>
					</li>
					<li>
						<a href="./settings.html">
							<span class="icon is-small"><i class="fas fa-cog" aria-hidden="true"></i></span>
							<span>Settings</span>
						</a>
					</li>
					<li>
						<a href="./about.html">
							<span class="icon is-small"><i class="fas fa-info" aria-hidden="true"></i></span>
							<span>About</span>
						</a>
					</li>
				</ul>
			</div>

			<div class="field">
				<progress class="progress is-small is-info" max="100" id="loadbar" style="display: none">15%</progress>
				<label class="label">
					Album
					<span
						class="has-tooltip-right has-tooltip-multiline"
						data-tooltip="Album for the wallpaper. You can change setting of each album by selecting them and add more album by selecting the add more"
					>
						<i class="fas fa-info-circle"></i>
					</span>
				</label>
				<div class="control has-icons-left">
					<div class="select">
						<select onchange="selectAlbumHandler()" id="album-select"></select>
					</div>
					<span class="icon is-left">
						<i class="fas fa-image"></i>
					</span>
				</div>
			</div>

			<hr />

			<div id="album-info">
				<div class="columns">
					<div class="column">
						<div class="field">
							<label class="label">
								Album Name
								<span class="has-tooltip-right has-tooltip-multiline" data-tooltip="The Name of The Album"><i class="fas fa-info-circle"></i></span>
							</label>
							<div class="control">
								<input class="input" type="text" name="album-name" id="album-name" placeholder="Album Name" required />
							</div>
						</div>

						<div class="field">
							<label class="label">
								Base Folder
								<span class="has-tooltip-right has-tooltip-multiline" data-tooltip="Base folder for wallpaper imports and album scanning"><i class="fas fa-info-circle"></i></span>
							</label>

							<div class="control">
								<input class="input" type="text" name="base-folder" id="base-folder" placeholder="Base Folder" onclick="pathDialog()" />
							</div>
						</div>
					</div>

					<div class="column">
						<div class="field">
							<label class="label">
								Preferred Shuffle Interval (Minutes)
								<span
									class="has-tooltip-right has-tooltip-multiline"
									data-tooltip="Preferred shuffle interval for the queue. Will overwrite the setting in the queue page when switching album."
								>
									<i class="fas fa-info-circle"></i>
								</span>
							</label>

							<div class="control">
								<input class="input" type="number" name="shuffle-intervaL" id="shuffle-interval" placeholder="Preffered shuffle interval in minutes" min="1" required />
							</div>
						</div>

						<div class="field">
							<div class="control">
								<span
									class="has-tooltip-right has-tooltip-multiline"
									data-tooltip="Preffered order of the wallpaper in the album for the queue. Will overwrite the setting in the queue page when switching album."
								>
									<label class="checkbox">
										<input type="checkbox" name="random-order" id="random-order" />
										Preferred Random Order
									</label>
								</span>
							</div>
						</div>
					</div>
				</div>

				<div class="is-flex">
					<div class="field is-grouped mx-auto">
						<p class="control">
							<a class="button is-primary is-small" id="save">
								<span class="icon is-small">
									<i class="fas fa-save" aria-hidden="true"></i>
								</span>
								<span>Save</span>
							</a>
						</p>
						<p class="control">
							<a class="button is-warning is-small" id="cancel">
								<span class="icon is-small">
									<i class="fas fa-times" aria-hidden="true"></i>
								</span>
								<span>Cancel</span>
							</a>
						</p>
						<p class="control">
							<a class="button is-danger is-small" id="delete">
								<span class="icon is-small">
									<i class="fas fa-trash" aria-hidden="true"></i>
								</span>
								<span>Delete</span>
							</a>
						</p>
					</div>
				</div>
			</div>

			<hr />

			<div class="is-flex">
				<div class="field is-grouped mx-auto">
					<p class="control">
						<a class="button is-primary" id="load-images">
							<span class="icon is-small">
								<i class="fas fa-eye" aria-hidden="true"></i>
							</span>
							<span>Load Album Images</span>
						</a>
					</p>

					<p class="control">
						<a class="button is-link" id="sync-folder">
							<span class="icon is-primary">
								<i class="fas fa-sync" aria-hidden="true"></i>
							</span>
							<span>Sync Album to Base Folder</span>
						</a>
					</p>

					<p class="control">
						<a class="button is-info" id="add-images">
							<span class="icon is-small">
								<i class="fas fa-plus" aria-hidden="true"></i>
							</span>
							<span>Add Image to Album</span>
						</a>
					</p>
				</div>
			</div>

			<div class="m-3" id="the-images">
				<div class="is-flex-direction-row" id="img-container"></div>
			</div>
		</div>

		<script defer type="text/javascript">
			document.getElementById("shuffle-interval").addEventListener("change", function () {
				if (this.value < 1) {
					this.value = 1;
				}
			});

			// prevent any input in base-folder
			document.getElementById("base-folder").addEventListener("keydown", function (e) {
				e.preventDefault();
			});

			const { ipcRenderer } = require("electron");
			const albumSelect_El = document.getElementById("album-select");
			const albumName_El = document.getElementById("album-name");
			const baseFolder_El = document.getElementById("base-folder");
			const randomOrder_El = document.getElementById("random-order");
			const shuffleInterval_El = document.getElementById("shuffle-interval");

			let selectedAlbum = "",
				selectedAlbumData = {},
				allAlbum = [];

			const fillData = (data) => {
				albumName_El.value = data.name;
				baseFolder_El.value = data.baseFolder;
				randomOrder_El.checked = data.preferred_Random;
				shuffleInterval_El.value = data.preferred_shuffle_interval;
			};

			const listUpdate = (albumList) => {
				albumSelect_El.innerHTML = "";

				albumList.forEach((album) => {
					const option = document.createElement("option");
					option.value = album.name;
					option.innerText = album.name;
					albumSelect_El.appendChild(option);
				});

				const lastOpt = document.createElement("option");
				lastOpt.value = "Add more";
				lastOpt.innerText = "Add more";
				albumSelect_El.appendChild(lastOpt);

				// get current album
				selectedAlbum = ipcRenderer.sendSync("get-current-album");
				selectedAlbumData = ipcRenderer.sendSync("get-current-album-data", selectedAlbum[0]);

				// set selected album as the current album and fill the data
				albumSelect_El.value = selectedAlbum;
				fillData(selectedAlbumData);
			};

			// ================================================================
			// page open
			// ================================================================
			// get all album first
			allAlbum = ipcRenderer.sendSync("get-settings", "album");
			listUpdate(allAlbum);

			// ================================================================
			// handler
			// ================================================================
			const selectAlbumHandler = () => {
				const album = albumSelect_El.value;
				selectedAlbum = album;
				if (album === "Add more") {
					selectedAlbumData = {};
					albumName_El.value = "";
					baseFolder_El.value = "";
					randomOrder_El.checked = false;
					shuffleInterval_El.value = 30;

					document.getElementById("img-container").innerHTML = "";
				} else {
					selectedAlbumData = ipcRenderer.sendSync("get-current-album-data", selectedAlbum);
					fillData(selectedAlbumData);

					document.getElementById("img-container").innerHTML = "";
					// selectedAlbumData.active_wp.forEach((image) => {
					// 	const img = document.createElement("img");
					// 	img.src = image;
					// 	img.className = "image is-128x128";
					// 	document.getElementById("img-container").appendChild(img);
					// });
				}
			};

			const pathDialog = () => {
				const baseFolder = document.getElementById("base-folder").value;

				const res = ipcRenderer.sendSync("dialogbox", ["openDirectory", baseFolder]);

				if (res) document.getElementById("base-folder").value = res;
			};

			// save
			document.getElementById("save").addEventListener("click", () => {
				// show loadbar
				document.getElementById("loadbar").style.display = "block";

				// delay for .1 second to show the loadbar first
				setTimeout(() => {
					const albumName = albumName_El.value.trim();
					const baseFolder = baseFolder_El.value.trim();
					const randomOrder = randomOrder_El.checked;
					const shuffleInterval = shuffleInterval_El.value;

					if (albumName.length === 0) {
						ipcRenderer.send("dialogbox", ["error", "Album name cannot be empty!"]);
						setTimeout(() => (document.getElementById("loadbar").style.display = "none"), 1000);
						return;
					}

					// invalid albumName
					if (albumName.toLowerCase() === "add more") {
						ipcRenderer.send("dialogbox", ["error", "Invalid album name provided!"]);
						setTimeout(() => (document.getElementById("loadbar").style.display = "none"), 1000);
						return;
					}

					if (baseFolder.length === 0) {
						const confirmation = ipcRenderer.sendSync("dialogbox", ["warning", "Base folder is empty, continue?"]);
						if (confirmation === 1) {
							setTimeout(() => (document.getElementById("loadbar").style.display = "none"), 1000);
							return;
						} // no
					}

					if (selectedAlbum === "Add more") {
						let active_wp = [];

						// check if albumName already exist in allAlbum
						if (allAlbum.some((album) => album.name === albumName)) {
							ipcRenderer.send("dialogbox", ["error", "Album with the same name already exist!"]);
							setTimeout(() => (document.getElementById("loadbar").style.display = "none"), 1000);
							return;
						}

						if (baseFolder.length > 0) {
							active_wp = getFilesInFolder(baseFolder);
							active_wp = filterImages(active_wp);
						}

						// add
						const albumData = {
							name: albumName,
							baseFolder: baseFolder,
							active_wp: active_wp,
							inactive_wp: [],
							preferred_Random: randomOrder,
							preferred_shuffle_interval: parseInt(shuffleInterval),
						};
						ipcRenderer.send("add-album", albumData);
					} else {
						// get current album data first
						let currentAlbumData = ipcRenderer.sendSync("get-current-album-data", selectedAlbumData.name);
						let new_active_wp = [];

						currentAlbumData.name = albumName;
						currentAlbumData.preferred_Random = randomOrder;
						currentAlbumData.preferred_shuffle_interval = parseInt(shuffleInterval);

						if (currentAlbumData.baseFolder !== baseFolder) {
							currentAlbumData.baseFolder = baseFolder;
							new_active_wp = getFilesInFolder(baseFolder);
							new_active_wp = filterImages(new_active_wp);

							// add new active wp to current active wp but make sure no duplicate
							const newArr = [...currentAlbumData.active_wp, ...new_active_wp];
							currentAlbumData.active_wp = [...new Set(newArr)];

							// remove active wp that is currently in inactive_wp
							currentAlbumData.active_wp = currentAlbumData.active_wp.filter((active_wp) => {
								return !currentAlbumData.inactive_wp.includes(active_wp);
							});
						}

						ipcRenderer.send("update-album", [selectedAlbumData.name, currentAlbumData]); // [albumName, updatedData]
					}

					// update select
					allAlbum = ipcRenderer.sendSync("get-settings", "album");
					listUpdate(allAlbum);

					// close loadbar
					setTimeout(() => (document.getElementById("loadbar").style.display = "none"), 500);
				}, 200);
			});

			// cancel
			document.getElementById("cancel").addEventListener("click", () => {
				const confirmation = ipcRenderer.sendSync("dialogbox", ["warning", "You will lose all changes made, continue?"]);
				if (confirmation === 1) return;

				if (selectedAlbum !== "Add more") {
					fillData(selectedAlbumData);
				} else {
					albumName_El.value = "";
					baseFolder_El.value = "";
					randomOrder_El.checked = false;
					shuffleInterval_El.value = 30;
				}
			});
		</script>
	</body>
</html>
