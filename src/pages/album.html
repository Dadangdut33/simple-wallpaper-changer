<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Simple Wallpaper Changer</title>
		<link rel="stylesheet" href="../style/bulma.min.css" />
		<link rel="stylesheet" href="../style/bulma-tooltip.css" />
		<link rel="stylesheet" href="../style/fa-all.min.css" />
		<link rel="stylesheet" href="../style/index.css" />
		<script defer src="../js/handler/files.js"></script>
		<script defer src="../js/handler/image.js"></script>
	</head>

	<body>
		<div class="box menu-container content">
			<div class="tabs is-centered">
				<ul class="m-0">
					<li>
						<a href="../index.html" onclick="pageSwitchingHandler()">
							<span class="icon is-small"><i class="fas fa-home" aria-hidden="true"></i></span>
							<span>Main Menu</span>
						</a>
					</li>
					<li class="is-active">
						<a>
							<span class="icon is-small"><i class="fas fa-images" aria-hidden="true"></i></span>
							<span>Album</span>
						</a>
					</li>
					<li>
						<a href="./settings.html" onclick="pageSwitchingHandler()">
							<span class="icon is-small"><i class="fas fa-cog" aria-hidden="true"></i></span>
							<span>Settings</span>
						</a>
					</li>
					<li>
						<a href="./about.html" onclick="pageSwitchingHandler()">
							<span class="icon is-small"><i class="fas fa-info" aria-hidden="true"></i></span>
							<span>About</span>
						</a>
					</li>
				</ul>
			</div>

			<div id="toast" class="toast" style="display: none">
				<p id="toast-text"></p>
				<span id="toast-close" class="toast-close">
					<i class="fas fa-times"></i>
				</span>
			</div>

			<div class="field">
				<progress class="progress is-small is-info" max="100" id="loadbar" style="display: none">15%</progress>
				<label class="label">
					Album
					<span
						class="has-tooltip-right has-tooltip-multiline"
						data-tooltip="Album for the wallpaper. You can change setting of each album by selecting them and add more album by selecting the add more"
					>
						<i class="fas fa-info-circle"></i>
					</span>
				</label>
				<div class="control has-icons-left">
					<div class="select">
						<select onchange="selectAlbumHandler()" id="album-select"></select>
					</div>
					<span class="icon is-left">
						<i class="fas fa-image"></i>
					</span>
				</div>
			</div>

			<hr />

			<div id="album-info">
				<div class="columns">
					<div class="column">
						<div class="field">
							<label class="label">
								Album Name
								<span class="has-tooltip-right has-tooltip-multiline" data-tooltip="The Name of The Album"><i class="fas fa-info-circle"></i></span>
							</label>
							<div class="control">
								<input class="input" type="text" name="album-name" id="album-name" placeholder="Album Name" required />
							</div>
						</div>
					</div>

					<div class="column">
						<div class="field">
							<label class="label">
								Base Folder
								<span class="has-tooltip-right has-tooltip-multiline" data-tooltip="Base folder for wallpaper imports and album scanning"><i class="fas fa-info-circle"></i></span>
							</label>

							<div class="control">
								<input class="input" type="text" name="base-folder" id="base-folder" placeholder="Base Folder" onclick="pathDialog()" />
							</div>
						</div>
					</div>
				</div>

				<div class="is-flex">
					<div class="field is-grouped mx-auto">
						<p class="control">
							<a class="button is-primary is-small" id="save">
								<span class="icon is-small">
									<i class="fas fa-save" aria-hidden="true"></i>
								</span>
								<span>Save</span>
							</a>
						</p>
						<p class="control">
							<a class="button is-warning is-small" id="cancel">
								<span class="icon is-small">
									<i class="fas fa-times" aria-hidden="true"></i>
								</span>
								<span>Cancel</span>
							</a>
						</p>
						<p class="control">
							<a class="button is-danger is-small" id="delete">
								<span class="icon is-small">
									<i class="fas fa-trash" aria-hidden="true"></i>
								</span>
								<span>Delete</span>
							</a>
						</p>
					</div>
				</div>
			</div>

			<hr />

			<div class="is-flex">
				<div class="field is-grouped mx-auto">
					<p class="control">
						<a class="button is-primary is-small" id="load-images">
							<span class="icon is-small">
								<i class="fas fa-eye" aria-hidden="true"></i>
							</span>
							<span>Load Album Images</span>
						</a>
					</p>

					<p class="control">
						<a class="button is-link is-small" id="sync-folder">
							<span class="icon is-primary">
								<i class="fas fa-sync" aria-hidden="true"></i>
							</span>
							<span>Sync Album with Base Folder</span>
						</a>
					</p>

					<p class="control">
						<a class="button is-info is-small" id="add-images">
							<span class="icon is-small">
								<i class="fas fa-plus" aria-hidden="true"></i>
							</span>
							<span>Add Image to Album</span>
						</a>
					</p>

					<p class="control">
						<a class="button is-danger is-small" id="add-images">
							<span class="icon is-small">
								<i class="fas fa-trash" aria-hidden="true"></i>
							</span>
							<span>Delete ALL Images</span>
						</a>
					</p>
				</div>
			</div>

			<div class="m-3" id="the-images">
				<div class="is-flex-direction-row" id="img-container"></div>
			</div>
		</div>

		<script defer type="text/javascript">
			// prevent any input in base-folder
			document.getElementById("base-folder").addEventListener("keydown", function (e) {
				e.preventDefault();
			});

			const { ipcRenderer } = require("electron");
			const shell = require("electron").shell;
			const albumSelect_El = document.getElementById("album-select");
			const albumName_El = document.getElementById("album-name");
			const baseFolder_El = document.getElementById("base-folder");
			const toast = document.getElementById("toast");
			const toast_text = document.getElementById("toast-text");
			const toast_close = document.getElementById("toast-close");
			const imgContainer = document.getElementById("img-container");
			const loadBar = document.getElementById("loadbar");

			let selectedAlbum_Name = "",
				selectedAlbumData = {},
				allAlbum = [];

			const fillData = (data) => {
				albumName_El.value = data.name;
				baseFolder_El.value = data.baseFolder;
			};

			const listUpdate = (albumList, getRuntime = true) => {
				albumSelect_El.innerHTML = "";

				albumList.forEach((album) => {
					const option = document.createElement("option");
					option.value = album.name;
					option.innerText = album.name;
					albumSelect_El.appendChild(option);
				});

				const lastOpt = document.createElement("option");
				lastOpt.value = "Add more";
				lastOpt.innerText = "Add more";
				albumSelect_El.appendChild(lastOpt);

				// get current album // if getRunTime else stays on the same album
				if (getRuntime) {
					selectedAlbum_Name = ipcRenderer.sendSync("get-current-album")[0];
					selectedAlbumData = ipcRenderer.sendSync("get-current-album-data", selectedAlbum_Name);

					// set selected album as the current album and fill the data
					albumSelect_El.value = selectedAlbum_Name;
					fillData(selectedAlbumData);
				}
			};

			const wallpaper = require("wallpaper");
			const { clipboard } = require("electron");
			const setWallpaper = async (path) => {
				try {
					await wallpaper.set(path);
				} catch (error) {
					ipcRenderer.send("dialogbox", ["error", error.message]);
				}
			};

			const openInExplorer = (path) => {
				shell.openPath(path);
			};

			const copyToClipboard = (path) => {
				showToast("Copied to clipboard");
				clipboard.writeText(path);

				setTimeout(() => {
					closeToast();
				}, 1000);
			};

			const setActiveInactive = (el_this, id_num, path) => {
				if (el_this.id === "active") {
					ipcRenderer.send("set-img-inactive", [selectedAlbum_Name, path]);
					el_this.id = "inactive";
					document.getElementById("desc-span-" + id_num).className = "skipped";
				} else {
					ipcRenderer.send("set-img-active", [selectedAlbum_Name, path]);
					el_this.id = "active";
					document.getElementById("desc-span-" + id_num).className = "";
				}
			};

			const deleteFromList = (el_this, id_num, path) => {
				const activeOrNot = document.getElementById("desc-span-" + id_num).className === "skipped" ? true : false;

				ipcRenderer.send("delete-img", [selectedAlbum_Name, path, activeOrNot]);

				// remove from the list
				document.getElementById("img-wrapper-" + id_num).remove();
			};

			const loadImage = (images, active = true) => {
				showToast("Loading images... Please wait as this might take a while depending on your computer's performance and the amount of images in the album.");
				loadBar.style.display = "block";
				images.some((image, i) => {
					const div = document.createElement("div");
					div.className = "img-wrapper";
					div.id = "img-wrapper-" + i;
					div.onmouseenter = () => {
						showDesc(i);
					};
					div.onmouseleave = () => {
						hideDesc(i);
					};

					// span
					const span = document.createElement("span");
					span.id = "desc-span-" + i;
					if (!active) span.className = "skipped";

					div.appendChild(span);

					const img = document.createElement("img");
					img.src = image;
					img.id = "image";
					img.alt = `${image}`;
					div.appendChild(img);

					const desc = document.createElement("div");
					desc.className = "img-desc fadeIn";
					desc.style.display = "none";
					desc.id = `desc-${i}`;
					desc.innerHTML = `<p onclick="copyToClipboard('${image.replace(/\\/g, "/")}')" style="cursor: pointer;">${image}</p>`;
					div.appendChild(desc);

					const descHover = document.createElement("div");
					const iconApply = document.createElement("span");
					iconApply.className = "has-tooltip-bottom mx-1";
					iconApply.dataset.tooltip = "Set as current wallpaper";
					iconApply.innerHTML = `<i class="fas fa-check-circle" onclick="setWallpaper('${image.replace(/\\/g, "/")}')"></i>`;
					descHover.appendChild(iconApply);

					const iconSkip = document.createElement("span");
					iconSkip.className = "has-tooltip-bottom mx-1";
					iconSkip.dataset.tooltip = "Skip this wallpaper from the list";
					iconSkip.innerHTML = `<i class="fas fa-minus-circle" id="${active ? "active" : "inactive"}" onclick="setActiveInactive(this, ${i},'${image.replace(/\\/g, "/")}')"></i>`;
					descHover.appendChild(iconSkip);

					const iconDelete = document.createElement("span");
					iconDelete.className = "has-tooltip-bottom mx-1";
					iconDelete.dataset.tooltip = "Delete this wallpaper from the list";
					iconDelete.innerHTML = `<i class="fas fa-trash-alt" onclick="deleteFromList(this, ${i},'${image.replace(/\\/g, "/")}')"></i>`;
					descHover.appendChild(iconDelete);

					const iconOpen = document.createElement("span");
					iconOpen.className = "has-tooltip-bottom mx-1";
					iconOpen.dataset.tooltip = "Open this wallpaper in the default viewer";
					iconOpen.innerHTML = `<i class="fas fa-external-link-alt" onclick="openInExplorer('${image.replace(/\\/g, "/")}')"></i>`;
					descHover.appendChild(iconOpen);

					desc.appendChild(descHover);

					imgContainer.appendChild(div);
				});

				let timeoutTime = images.length > 20 ? 7000 : 2000;
				// delay 5 seconds to
				setTimeout(() => {
					loadBar.style.display = "none";
					closeToast();
				}, timeoutTime);
			};

			// ================================================================
			// Toast
			let toastCloseTimeout = null;
			const closeToast = () => {
				toast.classList.add("slide-out");
				clearTimeout(toastCloseTimeout);

				// timeout 0.45 seconds then add style display none
				toastCloseTimeout = setTimeout(() => {
					toast.style.display = "none";
				}, 450);
			};

			const showToast = (msg) => {
				toast.classList.remove("slide-out");
				toast.style.display = "block";
				toast_text.innerText = msg;
			};

			toast_close.addEventListener("click", closeToast);

			// ================================================================
			// page open
			// ================================================================
			// get all album first
			allAlbum = ipcRenderer.sendSync("get-settings", "album");
			listUpdate(allAlbum);

			// ================================================================
			// handler
			// ================================================================
			const saveChanges = () => {
				// show loadbar
				showToast("Saving changes...");
				loadBar.style.display = "block";

				const albumName = albumName_El.value.trim();
				const baseFolder = baseFolder_El.value.trim();

				if (albumName.length === 0) {
					ipcRenderer.send("dialogbox", ["error", "Album name cannot be empty!"]);
					setTimeout(() => {
						loadBar.style.display = "none";
						closeToast();
					}, 500);
					return;
				}

				// invalid albumName
				if (albumName.toLowerCase() === "add more") {
					ipcRenderer.send("dialogbox", ["error", "Invalid album name provided!"]);
					setTimeout(() => {
						loadBar.style.display = "none";
						closeToast();
					}, 500);
					return;
				}

				if (baseFolder.length === 0) {
					const confirmation = ipcRenderer.sendSync("dialogbox", ["warning", "Base folder is empty, continue?"]);
					if (confirmation === 1) {
						setTimeout(() => {
							loadBar.style.display = "none";
							closeToast();
						}, 500);
						return;
					} // no
				}

				if (selectedAlbum_Name === "Add more") {
					let active_wp = [];

					// check if albumName already exist in allAlbum
					if (allAlbum.some((album) => album.name.toLowerCase() === albumName.toLowerCase())) {
						ipcRenderer.send("dialogbox", ["error", "Album with the same name already exist!"]);
						setTimeout(() => {
							loadBar.style.display = "none";
							closeToast();
						}, 500);
						return;
					}

					if (baseFolder.length > 0) {
						active_wp = getFilesInFolder(baseFolder);
						active_wp = filterImages(active_wp);
					}

					// add
					const albumData = {
						name: albumName,
						baseFolder: baseFolder,
						active_wp: active_wp,
						inactive_wp: [],
					};
					ipcRenderer.send("add-album", albumData);

					selectedAlbum_Name = albumName;
					selectedAlbumData = albumData;
				} else {
					// get current album data first
					let currentAlbumData = ipcRenderer.sendSync("get-current-album-data", selectedAlbumData.name);
					let new_active_wp = [];

					// check if name is edited but it already exist in the album
					if (selectedAlbumData.name !== albumName) {
						if (allAlbum.some((album) => album.name.toLowerCase() === albumName.toLowerCase())) {
							ipcRenderer.send("dialogbox", ["error", "Album with the same name already exist!"]);
							setTimeout(() => {
								loadBar.style.display = "none";
								closeToast();
							}, 500);
							return;
						}
					}

					currentAlbumData.name = albumName;

					// check if basefolder is edited
					if (currentAlbumData.baseFolder !== baseFolder) {
						currentAlbumData.baseFolder = baseFolder;

						// if it is not empty
						if (baseFolder.length > 0) {
							new_active_wp = getFilesInFolder(baseFolder);
							new_active_wp = filterImages(new_active_wp);

							// add new active wp to current active wp but make sure no duplicate
							const newArr = [...currentAlbumData.active_wp, ...new_active_wp];
							currentAlbumData.active_wp = [...new Set(newArr)];

							// remove active wp that is currently in inactive_wp
							currentAlbumData.active_wp = currentAlbumData.active_wp.filter((active_wp) => {
								return !currentAlbumData.inactive_wp.includes(active_wp);
							});
						}
					}

					ipcRenderer.send("update-album", [selectedAlbumData.name, currentAlbumData]); // [albumName, updatedData]

					// update selected album data
					selectedAlbum_Name = albumName;
					selectedAlbumData = currentAlbumData;
				}

				// update allAlbum
				allAlbum = ipcRenderer.sendSync("get-settings", "album");

				// update select
				allAlbum = ipcRenderer.sendSync("get-settings", "album");
				listUpdate(allAlbum, false);

				// close loadbar
				setTimeout(() => {
					loadBar.style.display = "none";
					closeToast();
				}, 500);
			};

			const checkChanges = () => {
				if (selectedAlbum_Name !== "Add more") {
					if (selectedAlbumData.name !== albumName_El.value || selectedAlbumData.baseFolder !== baseFolder_El.value) {
						const res = ipcRenderer.sendSync("dialogbox", ["yesno", "You have unsaved changes. Do you want to save them?"]);
						if (res === 0) saveChanges();
					}
				} else if (albumName_El.value.length > 0 || baseFolder_El.value.value > 0) {
					const res = ipcRenderer.sendSync("dialogbox", ["yesno", "You have unsaved changes. Do you want to save them?"]);
					if (res === 0) saveChanges();
				}
			};

			const pageSwitchingHandler = () => {
				checkChanges();

				return true;
			};

			const selectAlbumHandler = () => {
				checkChanges();

				const album = albumSelect_El.value;
				selectedAlbum_Name = album;
				btnLoadImg.style.display = "block";
				if (album === "Add more") {
					selectedAlbumData = {};
					albumName_El.value = "";
					baseFolder_El.value = "";

					document.getElementById("img-container").innerHTML = "";
				} else {
					selectedAlbumData = ipcRenderer.sendSync("get-current-album-data", selectedAlbum_Name);
					fillData(selectedAlbumData);

					document.getElementById("img-container").innerHTML = "";
				}
			};

			const pathDialog = () => {
				const baseFolder = document.getElementById("base-folder").value;

				const res = ipcRenderer.sendSync("dialogbox", ["openDirectory", baseFolder]);

				if (res) document.getElementById("base-folder").value = res;
			};

			// save
			document.getElementById("save").addEventListener("click", () => {
				saveChanges();
			});

			// cancel
			document.getElementById("cancel").addEventListener("click", () => {
				const confirmation = ipcRenderer.sendSync("dialogbox", ["warning", "You will lose all changes made, continue?"]);
				if (confirmation === 1) return;

				if (selectedAlbum_Name !== "Add more") {
					fillData(selectedAlbumData);
				} else {
					albumName_El.value = "";
					baseFolder_El.value = "";
				}
			});

			// delete
			document.getElementById("delete").addEventListener("click", () => {
				const confirmation = ipcRenderer.sendSync("dialogbox", ["warning", "You will lose all data of this album, continue?"]);
				if (confirmation === 1) return;

				// check if album is selected
				if (selectedAlbum_Name === "Add more") {
					ipcRenderer.send("dialogbox", ["error", "Please select an album to delete"]);
					return;
				}

				// check selected album is in the runtime
				const runTimeAlbum = ipcRenderer.sendSync("get-current-album");
				if (runTimeAlbum.includes(selectedAlbum_Name)) {
					ipcRenderer.send("dialogbox", ["error", "You can't delete an album that is currently in use"]);
					return;
				}

				ipcRenderer.send("delete-album", selectedAlbum_Name);
				allAlbum = ipcRenderer.sendSync("get-settings", "album");
				listUpdate(allAlbum);
			});

			// ================================================================
			// btn bottom
			// ================================================================
			const btnLoadImg = document.getElementById("load-images");

			const btnLoadImgClick = () => {
				btnLoadImg.style.display = "none";

				loadImage(selectedAlbumData.active_wp);
				loadImage(selectedAlbumData.inactive_wp);
			};
			btnLoadImg.addEventListener("click", () => btnLoadImgClick());

			// ================================================================
			// update data from ipcmain
			// ================================================================
			ipcRenderer.on("update-album-data", (event, arg) => {
				allAlbum = ipcRenderer.sendSync("get-settings", "album");
				listUpdate(allAlbum, false);

				showToast("Album has been updated by the app. Reload album image if needed.");
			});
		</script>
	</body>
</html>
